<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixboard Pro - Ultimate Fix</title>
    <!-- Core Libraries -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Liu+Jian+Mao+Cao&family=Long+Cang&family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700;900&family=Noto+Serif+SC:wght@700&family=ZCOOL+KuaiLe&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+XiaoWei&family=Zhi+Mang+Xing&family=Bangers&family=Fredoka:wght@600&family=Righteous&family=Lobster&family=Alfa+Slab+One&family=Russo+One&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Aurora Colors */
            --aurora-bg: 
                radial-gradient(at 0% 0%, hsla(253,16%,90%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(260, 100%, 85%, 1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(200, 100%, 85%, 1) 0, transparent 50%),
                radial-gradient(at 0% 50%, hsla(300, 100%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 100% 100%, hsla(240, 100%, 85%, 1) 0, transparent 50%);

            --glass: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.6);
            --primary: #6c5ce7;
            --primary-grad: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            --text-main: #2d3436;
            --text-sub: #636e72;
        }

        /* --- Global Reset --- */
        * { box-sizing: border-box; outline: none; }
        
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; /* Prevent scrolling */
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #ffffff;
            /* Dynamic Background */
            background-image: var(--aurora-bg);
            background-size: 200% 200%;
            animation: auroraMove 15s ease infinite alternate;
            color: var(--text-main);
            user-select: none;
        }

        @keyframes auroraMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* --- Absolute Layout Structure --- */
        
        /* 1. Sidebar (Fixed Left) */
        .sidebar {
            position: absolute; top: 0; left: 0; bottom: 0; width: 380px;
            background: var(--glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
            z-index: 20;
            box-shadow: 10px 0 30px rgba(0,0,0,0.02);
        }

        /* 2. Viewport (Fills remaining space) */
        .viewport {
            position: absolute; top: 0; left: 380px; right: 0; bottom: 0;
            z-index: 10;
            overflow: hidden;
            background: transparent; /* Transparent to show aurora */
            background-image: radial-gradient(rgba(108, 92, 231, 0.1) 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            cursor: grab;
        }
        .viewport:active { cursor: grabbing; }

        /* 3. Canvas (Full Size of Viewport) */
        canvas {
            display: block; width: 100%; height: 100%;
        }

        /* 4. Top Actions (Fixed Top-Right) */
        .top-actions {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 16px; border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.6);
            align-items: center;
        }

        /* --- UI Components --- */
        .header { padding: 24px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 22px; font-weight: 800; color: #2d3436; }
        .brand span { color: var(--primary); background: rgba(108, 92, 231, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; vertical-align: middle; }

        .content { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 20px; }
        .content::-webkit-scrollbar { width: 0; }

        .card { background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.6); border-radius: 16px; padding: 18px; transition: 0.2s; }
        .card.active { background: #fff; border-color: var(--primary); box-shadow: 0 8px 24px rgba(108, 92, 231, 0.12); transform: translateX(4px); }
        .card-title { font-size: 11px; font-weight: 700; color: #b2bec3; text-transform: uppercase; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }

        .row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .row label { font-size: 12px; width: 40px; color: #636e72; flex-shrink: 0; font-weight: 600; }
        
        input, select {
            background: rgba(255,255,255,0.8); border: 1px solid #dfe6e9; color: #2d3436;
            padding: 0 10px; border-radius: 8px; font-size: 13px; width: 100%;
            transition: 0.2s; height: 36px;
        }
        input:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.15); }
        
        input[type="color"] { padding: 0; width: 36px; min-width: 36px; cursor: pointer; border: 3px solid #fff; overflow: hidden; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input[type="range"] { -webkit-appearance: none; height: 6px; background: rgba(0,0,0,0.05); padding: 0; border: none; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.1s; }

        button {
            background: rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.05); color: #636e72;
            padding: 8px 14px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 600;
            transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; justify-content: center;
        }
        button:hover { border-color: var(--primary); color: var(--primary); background: #fff; transform: translateY(-1px); }
        
        button.primary {
            background: var(--primary-grad); border: none; color: white !important; width: 100%; padding: 12px;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); font-size: 14px;
        }
        button.primary:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4); }
        button.icon-only { width: 36px; padding: 0; font-size: 16px; }
        button.danger { color: #e74c3c; border-color: #fab1a0; background: #fff5f5; }

        .palette { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;}
        .dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: 0.2s; }
        .dot:hover { transform: scale(1.15); z-index: 2; }

        .drop-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.8);
            border: 8px dashed var(--primary); z-index: 999;
            display: none; align-items: center; justify-content: center;
            font-size: 32px; font-weight: 800; color: var(--primary); backdrop-filter: blur(10px);
        }
        
        .empty-tip { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; pointer-events:none; opacity:0.6; color:#2d3436; width:100%; }
        .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; display: none; flex-direction:column; justify-content: center; align-items: center; color:#2d3436; font-weight:bold;}

        /* Modal */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: #fff; width: 400px; padding: 24px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popIn 0.2s ease;
        }
        @keyframes popIn { from {transform:scale(0.95); opacity:0} to {transform:scale(1); opacity:1} }
        .preset-list { max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-top: 15px;}
        .preset-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; transition: 0.2s; }
        .preset-item:hover { background: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(108, 92, 231, 0.1); }
    </style>
</head>
<body>

<div class="drop-overlay" id="drop-overlay">üìÇ ÊùæÂºÄÈº†Ê†áÊ∑ªÂä†ÂõæÁâá</div>
<div class="loader" id="loader">Processing...</div>

<!-- Âè≥‰∏äËßíÔºöÂØºÂá∫ -->
<div class="top-actions">
    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
        <span style="font-size:10px; color:#b2bec3; font-weight:bold;">EXPORT</span>
        <div style="display:flex; gap:5px; align-items:center;">
            <input type="number" id="dl-start" value="1" title="Ëµ∑ÂßãÂè∑" oninput="app.render()" style="width:36px; height:20px; padding:0; text-align:center; border:none; background:transparent;">
            <span style="color:#d1d5db; font-size:12px;">-</span>
            <input type="number" id="dl-count" value="5" title="Êï∞Èáè" style="width:36px; height:20px; padding:0; text-align:center; border:none; background:transparent;">
        </div>
    </div>
    <div style="width:1px; height:24px; background:rgba(0,0,0,0.1);"></div>
    <select id="dl-type" style="width:110px; background:transparent; border:none; font-weight:600; color:#636e72;">
        <option value="single">ÈÄêÂº†‰∏ãËΩΩ</option>
        <option value="zip">ÊâìÂåÖ ZIP</option>
    </select>
    <button class="primary" onclick="app.download()">ÂØºÂá∫Êñá‰ª∂</button>
</div>

<!-- ÂºπÁ™ó -->
<div class="modal-mask" id="save-modal">
    <div class="modal">
        <h3 style="margin:0 0 15px 0;">‰øùÂ≠òÈ¢ÑËÆæ</h3>
        <input type="text" id="preset-name-input" placeholder="ËæìÂÖ•È¢ÑËÆæÂêçÁß∞" style="height:44px; margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button onclick="app.closeModal('save')" style="flex:1">ÂèñÊ∂à</button>
            <button class="primary" onclick="app.confirmSave()" style="flex:1">Á°ÆËÆ§‰øùÂ≠ò</button>
        </div>
    </div>
</div>
<div class="modal-mask" id="load-modal">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">ËØªÂèñÈ¢ÑËÆæ</h3>
            <span onclick="app.closeModal('load')" style="cursor:pointer; font-size:20px;">√ó</span>
        </div>
        <div class="preset-list" id="preset-list"></div>
    </div>
</div>

<div class="sidebar">
    <div class="header">
        <div class="brand">Mixboard <span>PRO</span></div>
        <div style="display:flex; gap:6px;">
            <button class="icon-only" onclick="app.undo()" title="Êí§Âõû">‚Ü©</button>
            <button class="icon-only" onclick="app.redo()" title="ÈáçÂÅö">‚Ü™</button>
            <button onclick="app.openSave()" title="‰øùÂ≠ò">üíæ</button>
            <button onclick="app.reset(true)" title="ÈáçÁΩÆ">‚Üª</button>
        </div>
    </div>
    
    <div class="content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: -10px;">
            <label style="font-size:11px; font-weight:700; color:#b2bec3;">QUICK ACTIONS</label>
            <button onclick="app.openLoad()" style="padding:6px 12px; font-size:11px; background:rgba(108,92,231,0.08); color:var(--primary); border:none;">üìÇ ËØªÂèñÈ¢ÑËÆæ</button>
        </div>

        <!-- 1. ÂÖ®Â±Ä -->
        <div class="card" id="p-global">
            <div class="card-title">
                <span>ÁîªÂ∏É & Â∫ïËâ≤</span>
                <select id="ratio-preset" onchange="app.applyRatio(this.value)" style="width:90px; height:24px; padding:0; border:none; background:transparent; text-align:right;">
                    <option value="custom">Ëá™ÂÆö‰πâ</option>
                    <option value="750,1000">3:4 Â∞èÁ∫¢‰π¶</option>
                    <option value="720,1280">9:16 ÊäñÈü≥</option>
                    <option value="1280,720">16:9 Ê®™Â±è</option>
                    <option value="1080,1080">1:1 Ê≠£ÊñπÂΩ¢</option>
                </select>
            </div>
            <div class="row">
                <input type="number" id="cw" value="750" onchange="app.pushHistory(); app.resizeBoard()"> 
                <span>√ó</span> 
                <input type="number" id="ch" value="1000" onchange="app.pushHistory(); app.resizeBoard()">
            </div>
            <div class="row">
                <label>Â∫ïÊù°</label>
                <input type="color" id="barC" value="#ffffff" onchange="app.pushHistory()" oninput="app.render()">
                <input type="range" id="barH" max="500" value="220" onmousedown="app.pushHistory()" oninput="app.render()">
            </div>
            <div class="row">
                <label>ÁæΩÂåñ</label>
                <input type="range" id="barF" max="150" value="0" title="ËæπÁºòÁæΩÂåñÁ®ãÂ∫¶" onmousedown="app.pushHistory()" oninput="app.render()">
            </div>
            
            <div style="margin-top:12px;">
                <label style="font-size:11px; color:#9ca3af; font-weight:700;">ÈÖçËâ≤Êé®Ëçê</label>
                <div class="palette" id="smart-colors">
                    <div class="dot" style="background:#ffffff" onclick="app.applyColor('#ffffff')"></div>
                    <div class="dot" style="background:#2d3436" onclick="app.applyColor('#2d3436')"></div>
                    <div class="dot" style="background:#b2bec3" onclick="app.applyColor('#b2bec3')"></div>
                    <div class="dot" style="background:#ff7675" onclick="app.applyColor('#ff7675')"></div>
                    <div class="dot" style="background:#74b9ff" onclick="app.applyColor('#74b9ff')"></div>
                    <div class="dot" style="background:#a29bfe" onclick="app.applyColor('#a29bfe')"></div>
                    <div class="dot" style="background:#00cec9" onclick="app.applyColor('#00cec9')"></div>
                    <div class="dot" style="background:#fd79a8" onclick="app.applyColor('#fd79a8')"></div>
                </div>
            </div>

            <button class="primary" style="margin-top:15px;" onclick="document.getElementById('uplogo').click()">
                üñºÔ∏è ÊõøÊç¢ Logo
            </button>
            <input type="file" id="uplogo" hidden accept="image/*" onchange="app.loadImg(this, 'logo')">
        </div>

        <!-- 2. ÊñáÂ≠ó -->
        <div class="card" id="p-txt">
            <div class="card-title">
                <span>ÊñáÂ≠óÊ†∑Âºè</span>
                <button onclick="app.addText()" style="padding:4px 8px; font-size:10px;">+ Ê∑ªÂä†</button>
            </div>
            <input type="text" id="t-val" placeholder="ÈÄâÊã©ÊñáÂ≠ó..." onchange="app.pushHistory()" oninput="app.updateSel('val',this.value)" style="margin-bottom:10px; font-weight:bold;">
            <div class="row">
                <select id="t-font" onchange="app.pushHistory(); app.updateSel('font',this.value)">
                    <optgroup label="‰∏≠ÊñáÂ≠ó‰Ωì">
                        <option value="'Ma Shan Zheng'">Ê±üÊπñ‰Ωì (ÈªòËÆ§)</option>
                        <option value="'Zhi Mang Xing'">ÂøóËéΩË°å‰π¶</option>
                        <option value="'Long Cang'">ÈæôËãçÁãÇËçâ</option>
                        <option value="'ZCOOL QingKe HuangYou'">Á´ôÈÖ∑ÈªÑÊ≤π</option>
                        <option value="'Noto Sans SC'">ÊÄùÊ∫êÈªë‰Ωì</option>
                        <option value="'Noto Serif SC'">ÊÄùÊ∫êÂÆã‰Ωì</option>
                    </optgroup>
                    <optgroup label="Ëã±Êï∞È£éÊ†º">
                        <option value="'Bangers'">Bangers Êº´Áîª</option>
                        <option value="'Righteous'">Righteous ÁßëÂπª</option>
                        <option value="'Lobster'">Lobster Ëâ∫ÊúØ</option>
                        <option value="'Alfa Slab One'">Alfa Ë∂ÖÁ≤ó</option>
                    </optgroup>
                </select>
            </div>
            <div class="row"><label>Â≠óÂè∑</label><input type="range" min="20" max="400" id="t-s" onmousedown="app.pushHistory()" oninput="app.updateSel('s',this.value)"></div>
            <div class="row"><label>Á≤óÁªÜ</label><input type="range" min="100" max="900" id="t-w" onmousedown="app.pushHistory()" oninput="app.updateSel('w',this.value)"></div>
            <div class="row">
                <label>È¢úËâ≤</label><input type="color" id="t-c" onchange="app.pushHistory()" oninput="app.updateSel('c',this.value)">
                <label style="margin-left:auto;">Â≠óË∑ù</label><input type="range" min="-10" max="50" id="t-sp" onmousedown="app.pushHistory()" oninput="app.updateSel('sp',this.value)">
            </div>
            <div class="row">
                <label>Èò¥ÂΩ±</label><input type="color" id="t-sc" onchange="app.pushHistory()" oninput="app.updateSel('sc',this.value)">
                <input type="range" max="50" id="t-sb" onmousedown="app.pushHistory()" oninput="app.updateSel('sb',this.value)">
            </div>
        </div>

        <!-- 3. Â∫èÂè∑ -->
        <div class="card" id="p-num">
            <div class="card-title">Â∫èÂè∑Ê†∑Âºè</div>
            <div class="row">
                <select id="n-st" onchange="app.pushHistory(); app.updateSel('st',this.value)">
                    <option value="plain">Á∫ØÊï∞Â≠ó</option>
                    <option value="circle">ÂúÜÂúà ‚ë†</option>
                    <option value="box">ÊñπÂùó [1]</option>
                    <option value="underline">‰∏ãÂàíÁ∫ø _1_</option>
                </select>
                <input type="color" id="n-c" onchange="app.pushHistory()" oninput="app.updateSel('c',this.value)">
            </div>
            <div class="row">
                <select id="n-font" onchange="app.pushHistory(); app.updateSel('font',this.value)">
                    <option value="'Ma Shan Zheng'">Ê±üÊπñ‰Ωì (ÈªòËÆ§)</option>
                    <option value="'Arial'">Á≥ªÁªüÊï∞Â≠ó</option>
                    <option value="'ZCOOL QingKe HuangYou'">Á´ôÈÖ∑ÈªÑÊ≤π</option>
                </select>
            </div>
            <div class="row"><label>Â≠óÂè∑</label><input type="range" min="20" max="250" id="n-s" onmousedown="app.pushHistory()" oninput="app.updateSel('s',this.value)"></div>
            <div class="row"><label>Á≤óÁªÜ</label><input type="range" min="100" max="900" id="n-w" onmousedown="app.pushHistory()" oninput="app.updateSel('w',this.value)"></div>
            <div class="row">
                <label>Èò¥ÂΩ±</label><input type="color" id="n-sc" onchange="app.pushHistory()" oninput="app.updateSel('sc',this.value)">
                <input type="range" max="50" id="n-sb" onmousedown="app.pushHistory()" oninput="app.updateSel('sb',this.value)">
            </div>
        </div>
    </div>
</div>

<div class="viewport" id="viewport" tabindex="0">
    <canvas id="cvs"></canvas>
    <div class="empty-tip" id="empty-tip">
        <div style="font-size:48px; margin-bottom:16px;">üìÇ</div>
        <div style="font-weight:700; font-size:18px; color:#2d3436;">ÊãñÂÖ•ÂõæÁâáÂºÄÂßãËÆæËÆ°</div>
        <div style="color:#636e72; font-size:13px; margin-top:8px;">Á©∫Ê†º+ÊãñÊãΩÂπ≥Áßª | BackspaceÂà†Èô§</div>
    </div>
</div>

<script>
const DEF_LOGO_URL = "https://pic1.imgdb.cn/item/69367cdf2a4ee13cb9508e34.png";

function hexToRgba(hex, alpha) {
    let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}
function invertColor(hex) {
    if(hex.indexOf('rgb') > -1) return '#000';
    const r = parseInt(hex.substr(1,2),16), g = parseInt(hex.substr(3,2),16), b = parseInt(hex.substr(5,2),16);
    return (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000000' : '#ffffff';
}
const rgbToHex = (r,g,b) => "#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);

const app = {
    view: { x:0, y:0, zoom:0.65 },
    board: { w:750, h:1000 },
    items: [],
    history: [], ptr: -1,
    sel: null, mode: null, lastP: {x:0,y:0}, initV: {},
    cvs: document.getElementById('cvs'),
    ctx: document.getElementById('cvs').getContext('2d'),

    init() {
        window.addEventListener('resize', ()=>this.resizeView());
        window.addEventListener('keydown', e=>{
            const tag = document.activeElement.tagName;
            if(tag!=='INPUT' && tag!=='SELECT') {
                if(e.code==='Space') document.getElementById('viewport').style.cursor='grab';
                if(e.key==='Backspace'||e.key==='Delete') this.del();
                if((e.ctrlKey||e.metaKey)&&e.key==='z') { e.preventDefault(); this.undo(); }
                if((e.ctrlKey||e.metaKey)&&e.key==='y') { e.preventDefault(); this.redo(); }
            }
        });
        window.addEventListener('keyup', ()=>document.getElementById('viewport').style.cursor='default');
        
        const overlay = document.getElementById('drop-overlay');
        let dc=0;
        document.addEventListener('dragenter', e=>{e.preventDefault(); dc++; overlay.style.display='flex'});
        document.addEventListener('dragleave', e=>{e.preventDefault(); dc--; if(dc===0) overlay.style.display='none'});
        document.addEventListener('dragover', e=>e.preventDefault());
        document.addEventListener('drop', e=>{e.preventDefault(); dc=0; overlay.style.display='none'; this.handleDrop(e)});

        this.resizeView();
        // ÂÖ≥ÈîÆÔºöÂª∂ËøüÂàùÂßãÂåñ
        setTimeout(() => {
            this.reset();
            this.bindEvents();
        }, 100);
    },

    pushHistory() {
        if(this.ptr < this.history.length-1) this.history = this.history.slice(0, this.ptr+1);
        const st = JSON.stringify({ 
            items: this.items.map(x=>{const c={...x}; delete c.img; delete c._box; return c;}),
            board: this.board,
            bar: { h:document.getElementById('barH').value, f:document.getElementById('barF').value, c:document.getElementById('barC').value }
        });
        if(this.history.length && this.history[this.history.length-1]===st) return;
        this.history.push(st); this.ptr++;
    },
    undo() { if(this.ptr>0) { this.ptr--; this.restore(this.history[this.ptr]); } },
    redo() { if(this.ptr<this.history.length-1) { this.ptr++; this.restore(this.history[this.ptr]); } },
    
    restore(json) {
        try {
            const d = JSON.parse(json);
            this.board = d.board;
            ['cw','ch'].forEach(k => document.getElementById(k).value = this.board[k==='cw'?'w':'h']);
            ['barH','barF','barC'].forEach(k => document.getElementById(k).value = d.bar[k.replace('bar','').toLowerCase()] || (k==='barC'?'#fff':0));
            
            const cache = {}; this.items.forEach(i=>{if(i.img) cache[i.id||i.z] = i.img;});
            this.items = d.items.map(o => {
                if(o.type==='img'||o.id==='logo') {
                    if(cache[o.id||o.z]) o.img = cache[o.id||o.z];
                    else if(o.isLogo) { const i=new Image(); i.crossOrigin="Anonymous"; i.src=DEF_LOGO_URL; i.onload=()=>this.render(); o.img=i; }
                }
                return o;
            });
            this.sel = null; this.syncUI(); this.render();
        } catch(e) {}
    },

    reset(f) {
        if(f && !confirm("Á°ÆÂÆöÈáçÁΩÆÔºü")) return;
        this.board = {w:750, h:1000};
        ['cw','ch'].forEach(k=>document.getElementById(k).value = k==='cw'?750:1000);
        document.getElementById('barH').value=220; document.getElementById('barF').value=0; document.getElementById('barC').value='#ffffff';
        
        this.items = [
            { type:'img', id:'logo', isLogo:true, x:620, y:780, w:200, h:80, s:1, r:0, z:200 },
            { type:'txt', id:'title', val:'Ëµ§ÂΩ± ¬∑ ÊäòÂè†Â∞èÂàÄ', x:375, y:900, font:"'Ma Shan Zheng'", s:80, w:400, sp:0, c:'#000000', sc:'#000000', sb:0, r:0, z:201 },
            { type:'num', id:'num', val:1, x:690, y:950, font:"'Ma Shan Zheng'", st:'plain', s:80, w:400, c:'#000000', sc:'#000000', sb:0, r:0, z:202 }
        ];
        
        const i = new Image(); i.crossOrigin="Anonymous"; 
        i.onload = ()=>{ 
            const l=this.items.find(x=>x.id==='logo'); l.img=i; l.w=i.width; l.h=i.height; l.s=200/i.width; 
            this.render(); this.pushHistory();
        }; 
        i.src=DEF_LOGO_URL;
        
        this.history=[]; this.ptr=-1; this.centerView(); this.syncUI(null);
    },

    // --- Render ---
    render(exp=false, numOv=null) {
        const ctx = this.ctx;
        if(!this.cvs.width) this.resizeView(); // ÂÖúÂ∫ï
        
        if(!exp) {
            ctx.resetTransform(); ctx.clearRect(0,0,this.cvs.width, this.cvs.height);
            ctx.translate(this.view.x, this.view.y); ctx.scale(this.view.zoom, this.view.zoom);
            ctx.translate(-this.board.w/2, -this.board.h/2);
        } else {
            this.cvs.width=this.board.w; this.cvs.height=this.board.h; ctx.resetTransform();
        }

        ctx.fillStyle="#fff"; ctx.fillRect(0,0,this.board.w, this.board.h);
        if(!exp) { ctx.save(); ctx.shadowColor="rgba(0,0,0,0.15)"; ctx.shadowBlur=80; ctx.fillStyle="#fff"; ctx.fillRect(0,0,this.board.w,this.board.h); ctx.restore(); }

        const list = [...this.items].sort((a,b)=>a.z-b.z);
        if(!exp) document.getElementById('empty-tip').style.display = list.some(x=>x.type==='img'&&!x.isLogo) ? 'none' : 'block';

        ctx.save(); ctx.beginPath(); ctx.rect(0,0,this.board.w,this.board.h); ctx.clip();

        list.filter(x=>x.type==='img'&&!x.isLogo).forEach(o=>this.drawItem(ctx,o));

        const bH = parseInt(document.getElementById('barH').value), bF = parseInt(document.getElementById('barF').value), bC = document.getElementById('barC').value;
        if(bH>0) {
            if(bF>0) {
                const g = ctx.createLinearGradient(0, this.board.h-bH-bF, 0, this.board.h-bH);
                g.addColorStop(0, hexToRgba(bC,0)); g.addColorStop(1, bC);
                ctx.fillStyle=g; ctx.fillRect(0, this.board.h-bH-bF, this.board.w, bF+2);
            }
            ctx.fillStyle=bC; ctx.fillRect(0, this.board.h-bH, this.board.w, bH);
        }

        list.filter(x=>!(x.type==='img'&&!x.isLogo)).forEach(o=>{
            let v = null;
            if(o.type==='num') v = (exp && numOv!==null) ? numOv : document.getElementById('dl-start').value;
            this.drawItem(ctx, o, v);
        });
        ctx.restore();

        if(!exp && this.mode==='drag' && this.sel) this.drawGuides(ctx, this.sel);
        if(!exp && this.sel) this.drawBox(ctx, this.sel);
    },

    drawItem(ctx, o, vOverride) {
        if(!o.w) o.w=100; if(!o.h) o.h=100;
        ctx.save(); ctx.translate(o.x, o.y); ctx.rotate(o.r);
        if(o.sc && o.sb>0) { ctx.shadowColor=o.sc; ctx.shadowBlur=parseInt(o.sb); ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; }

        let bw=0, bh=0;
        if(o.type==='img' && o.img) {
            bw=o.w*o.s; bh=o.h*o.s; try{ctx.drawImage(o.img,-bw/2,-bh/2,bw,bh)}catch(e){}
        } else if(o.type==='txt') {
            ctx.fillStyle=o.c; const f=`${o.w} ${o.s}px ${o.font}`;
            const d=this.drawTxt(ctx, o.val, f, parseInt(o.sp)); bw=d.w; bh=o.s*1.2;
        } else if(o.type==='num') {
            const v = String(vOverride); ctx.fillStyle=o.c; ctx.font=`${o.w} ${o.s}px ${o.font}`;
            ctx.textAlign="center"; ctx.textBaseline="middle"; const m=ctx.measureText(v);
            if(o.st==='plain') { ctx.fillText(v,0,0); bw=m.width; bh=o.s*1.1; }
            else if(o.st==='circle') {
                const r=o.s*0.65; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.lineWidth=Math.max(2,o.s*0.05); ctx.strokeStyle=o.c; ctx.stroke();
                ctx.font=`${o.w} ${o.s*0.6}px ${o.font}`; ctx.fillText(v,0,o.s*0.05); bw=bh=r*2;
            } else if(o.st==='box') {
                ctx.font=`${o.w} ${o.s*0.7}px ${o.font}`; ctx.fillRect(-o.s*0.6,-o.s*0.6,o.s*1.2,o.s*1.2);
                ctx.fillStyle=invertColor(o.c); ctx.fillText(v,0,o.s*0.05); bw=bh=o.s*1.2;
            } else if(o.st==='underline') {
                ctx.fillText(v,0,0); ctx.fillRect(-m.width/2,o.s*0.5,m.width,Math.max(2,o.s*0.08)); bw=m.width; bh=o.s;
            }
        }
        o._box = {w:bw||50, h:bh||50}; ctx.restore();
    },

    drawTxt(ctx, t, f, sp) {
        ctx.font=f; ctx.textAlign="center"; ctx.textBaseline="middle";
        const arr=String(t).split(''), ws=[]; let tw=0;
        arr.forEach(c=>{const w=ctx.measureText(c).width; ws.push(w); tw+=w;});
        tw+=(arr.length-1)*sp; let cx=-tw/2;
        arr.forEach((c,i)=>{ctx.fillText(c,cx+ws[i]/2,0); cx+=ws[i]+sp;});
        return {w:tw};
    },

    drawBox(ctx, o) {
        if(!o._box) return;
        ctx.save(); ctx.translate(o.x, o.y); ctx.rotate(o.r);
        const w=o._box.w+10, h=o._box.h+10;
        ctx.strokeStyle="#6c5ce7"; ctx.lineWidth=1.5; ctx.strokeRect(-w/2,-h/2,w,h);
        ctx.fillStyle="#fff"; [[-w/2,-h/2],[w/2,-h/2],[-w/2,h/2],[w/2,h/2]].forEach(p=>{
            ctx.beginPath(); ctx.arc(p[0],p[1],5,0,Math.PI*2); ctx.fill(); ctx.stroke();
        });
        ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(0,h/2+25); ctx.stroke();
        ctx.beginPath(); ctx.arc(0,h/2+25,6,0,Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.restore();
    },

    drawGuides(ctx, o) {
        const cx=this.board.w/2, cy=this.board.h/2, snap=8;
        if(Math.abs(o.x-cx)<snap) { o.x=cx; ctx.save(); ctx.lineWidth=1; ctx.strokeStyle="#fd79a8"; ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,this.board.h); ctx.stroke(); ctx.restore(); }
        if(Math.abs(o.y-cy)<snap) { o.y=cy; ctx.save(); ctx.lineWidth=1; ctx.strokeStyle="#fd79a8"; ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(this.board.w,cy); ctx.stroke(); ctx.restore(); }
    },

    getPos(e) {
        const r=this.cvs.getBoundingClientRect();
        return {x:(e.clientX-r.left-this.view.x)/this.view.zoom+this.board.w/2, y:(e.clientY-r.top-this.view.y)/this.view.zoom+this.board.h/2};
    },
    toLoc(pt, o) {
        const dx=pt.x-o.x, dy=pt.y-o.y, c=Math.cos(-o.r), s=Math.sin(-o.r);
        return {x:dx*c-dy*s, y:dx*s+dy*c};
    },

    bindEvents() {
        const v = document.getElementById('viewport');
        const doc = document;
        let dc=0;
        doc.addEventListener('dragenter', e=>{e.preventDefault(); dc++; document.getElementById('drop-overlay').style.display='flex'});
        doc.addEventListener('dragleave', e=>{e.preventDefault(); dc--; if(dc===0) document.getElementById('drop-overlay').style.display='none'});
        doc.addEventListener('dragover', e=>e.preventDefault());
        doc.addEventListener('drop', e=>{e.preventDefault(); dc=0; document.getElementById('drop-overlay').style.display='none'; this.handleDrop(e)});

        v.addEventListener('mousedown', e=>{
            const p=this.getPos(e);
            if(e.code==='Space'||e.button===1) { this.mode='pan'; this.lastP={x:e.clientX, y:e.clientY}; return; }

            if(this.sel && this.sel._box) {
                const l=this.toLoc(p, this.sel), w=this.sel._box.w+14, h=this.sel._box.h+14;
                if(Math.hypot(l.x, l.y-(-h/2-25))<15) { this.pushHistory(); this.mode='rot'; this.initV={r:this.sel.r, ang:Math.atan2(p.y-this.sel.y, p.x-this.sel.x)}; return; }
                if(Math.abs(l.x)>w/2-15 && Math.abs(l.y)>h/2-15) { this.pushHistory(); this.mode='scale'; this.initV={s:this.sel.s, d:Math.hypot(p.x-this.sel.x, p.y-this.sel.y)}; return; }
            }

            const list = [...this.items].sort((a,b)=>b.z-a.z);
            let hit = null;
            for(let o of list) {
                if(!o._box) continue;
                const l=this.toLoc(p, o);
                if(Math.abs(l.x)<o._box.w/2 && Math.abs(l.y)<o._box.h/2) { hit=o; break; }
            }

            if(hit) {
                if(this.sel!==hit) { this.sel=hit; this.highlight(hit.type); this.syncUI(hit); }
                this.pushHistory(); this.mode='drag'; this.startP=p;
            } else {
                this.sel=null; this.mode='pan'; this.lastP={x:e.clientX, y:e.clientY};
                this.highlight('global');
            }
            this.render();
        });

        window.addEventListener('mousemove', e=>{
            if(!this.mode) return;
            if(this.mode==='pan') { this.view.x+=e.clientX-this.lastP.x; this.view.y+=e.clientY-this.lastP.y; this.lastP={x:e.clientX, y:e.clientY}; this.render(); return; }
            const p=this.getPos(e);
            if(this.mode==='drag'&&this.sel) { this.sel.x+=p.x-this.startP.x; this.sel.y+=p.y-this.startP.y; this.startP=p; }
            else if(this.mode==='rot'&&this.sel) { const ang=Math.atan2(p.y-this.sel.y, p.x-this.sel.x); this.sel.r=this.initV.r+(ang-this.initV.ang); }
            else if(this.mode==='scale'&&this.sel) { const d=Math.hypot(p.x-this.sel.x, p.y-this.sel.y); this.sel.s=Math.max(0.01, this.initV.s*(d/this.initV.d)); }
            this.render();
        });

        window.addEventListener('mouseup', ()=>this.mode=null);
        v.addEventListener('wheel', e=>{ e.preventDefault(); this.view.zoom*=e.deltaY>0?0.9:1.1; this.render(); }, {passive:false});
    },

    // --- Helpers ---
    resizeView() {
        this.cvs.width=document.getElementById('viewport').clientWidth;
        this.cvs.height=document.getElementById('viewport').clientHeight;
        this.render();
    },
    resizeBoard() { this.board.w=parseInt(document.getElementById('cw').value); this.board.h=parseInt(document.getElementById('ch').value); this.render(); },
    applyRatio(v) { if(v==='custom') return; const[w,h]=v.split(','); document.getElementById('cw').value=w; document.getElementById('ch').value=h; this.pushHistory(); this.resizeBoard(); this.centerView(); },
    centerView() { this.view.x=this.cvs.width/2; this.view.y=this.cvs.height/2; this.view.zoom=Math.min((this.cvs.width-100)/this.board.w, (this.cvs.height-100)/this.board.h); this.render(); },
    
    addText() {
        this.pushHistory();
        this.items.push({type:'txt', val:'ËæìÂÖ•ÊñáÂ≠ó', x:this.board.w/2, y:this.board.h/2, font:"'Ma Shan Zheng'", s:80, w:400, sp:0, c:'#000', sc:'#000', sb:0, r:0, z:300});
        this.sel=this.items[this.items.length-1]; this.highlight('txt'); this.syncUI(this.sel); this.render();
    },
    del() { if(this.sel) { this.pushHistory(); this.items=this.items.filter(i=>i!==this.sel); this.sel=null; this.render(); } },
    
    updateSel(k, v) { 
        if(!this.sel) return; 
        if(k==='font') document.fonts.load(`30px ${v}`).then(()=>{this.sel[k]=v; this.render()});
        else this.sel[k]=v; 
        this.render(); 
    },
    
    handleDrop(e) {
        const f=e.dataTransfer.files[0];
        if(f&&f.type.startsWith('image')) {
            const r=new FileReader();
            r.onload=ev=>{
                const i=new Image();
                i.onload=()=>{
                    this.extractColors(i); this.pushHistory();
                    this.items = this.items.filter(x=>x.type!=='img'||x.isLogo);
                    const s=Math.max(this.board.w/i.width, this.board.h/i.height);
                    this.items.push({type:'img', img:i, w:i.width, h:i.height, x:this.board.w/2, y:this.board.h/2, s:s, r:0, z:50});
                    this.render();
                }; i.src=ev.target.result;
            }; r.readAsDataURL(f);
        }
    },
    loadImg(el, t) {
        if(!el.files[0]) return; const r=new FileReader();
        r.onload=e=>{
            const i=new Image(); i.crossOrigin="Anonymous";
            i.onload=()=>{ this.pushHistory(); const l=this.items.find(x=>x.id==='logo'); l.img=i; l.w=i.width; l.h=i.height; l.s=200/i.width; this.render(); };
            i.src=e.target.result;
        }; r.readAsDataURL(el.files[0]);
    },
    extractColors(img) {
        const c=document.createElement('canvas'); c.width=50; c.height=50; const x=c.getContext('2d'); x.drawImage(img,0,0,50,50);
        const d=x.getImageData(0,0,50,50).data, colors=[];
        for(let i=0;i<d.length;i+=400) colors.push(`rgb(${d[i]},${d[i+1]},${d[i+2]})`);
        const dots=document.getElementById('smart-colors').children;
        [...new Set(colors)].slice(0,8).forEach((c,i)=>{ if(dots[i]) { dots[i].style.background=c; dots[i].onclick=()=>{this.pushHistory(); this.applyColor(this.rgbToHex(c))}; } });
    },
    applyColor(h) {
        document.getElementById('barC').value=h; const ic=invertColor(h);
        this.items.forEach(i=>{if(i.type==='txt'||i.type==='num')i.c=ic});
        if(this.sel) this.syncUI(this.sel); this.render();
    },
    rgbToHex(c) { const[r,g,b]=c.match(/\d+/g); return "#"+((1<<24)+(+r<<16)+(+g<<8)+(+b)).toString(16).slice(1); },
    
    highlight(t) { document.querySelectorAll('.card').forEach(c=>c.classList.remove('active')); document.getElementById(t==='txt'?'p-txt':(t==='num'?'p-num':'p-global')).classList.add('active'); },
    syncUI(o) {
        if(!o) return; const pf = o.type==='txt'?'t':'n';
        if(o.type==='txt') { document.getElementById('t-val').value=o.val; document.getElementById('t-sp').value=o.sp; }
        if(o.type==='num') document.getElementById('n-st').value=o.st;
        ['font','s','w','c','sc','sb'].forEach(k=>document.getElementById(`${pf}-${k}`).value=o[k]);
    },

    // --- Preset ---
    openSave() { document.getElementById('save-modal').style.display='flex'; },
    closeModal(t) { document.getElementById(t+'-modal').style.display='none'; },
    confirmSave() {
        const n = document.getElementById('preset-name-input').value; if(!n) return alert("ËØ∑ËæìÂÖ•ÂêçÁß∞");
        const data = this.items.filter(x=>x.type!=='img'||x.isLogo).map(x=>{const c={...x}; delete c.img; delete c._box; return c;});
        const st = {
            w:this.board.w, h:this.board.h, 
            bar: { h:document.getElementById('barH').value, f:document.getElementById('barF').value, c:document.getElementById('barC').value },
            items:data
        };
        localStorage.setItem('PRE_'+n, JSON.stringify(st));
        this.closeModal('save');
        alert("È¢ÑËÆæ‰øùÂ≠òÊàêÂäüÔºÅ");
    },
    openLoad() {
        const l = document.getElementById('preset-list'); l.innerHTML = '';
        Object.keys(localStorage).filter(k=>k.startsWith('PRE_')).forEach(k=>{
            const n = k.replace('PRE_','');
            l.innerHTML += `<div class="preset-item"><span class="preset-name">${n}</span><div class="preset-actions"><button onclick="app.loadP('${n}')">ËØªÂèñ</button><button class="danger" onclick="app.delP('${n}')">√ó</button></div></div>`;
        });
        document.getElementById('load-modal').style.display='flex';
    },
    loadP(n) {
        try {
            const raw = localStorage.getItem('PRE_'+n);
            if(!raw) return alert("ËØªÂèñÂ§±Ë¥•");
            const d = JSON.parse(raw);
            this.board=d.board; ['cw','ch'].forEach(k=>document.getElementById(k).value=this.board[k==='cw'?'w':'h']);
            ['barH','barF','barC'].forEach(k => document.getElementById(k).value = d.bar[k.replace('bar','').toLowerCase()] || (k==='barC'?'#fff':0));
            
            this.items = d.items.map(o => {
                if(o.type==='img'||o.id==='logo') {
                    if(o.isLogo) { const i=new Image(); i.crossOrigin="Anonymous"; i.src=DEF_LOGO_URL; i.onload=()=>this.render(); o.img=i; }
                }
                return o;
            });
            this.sel=null; this.pushHistory(); this.closeModal('load'); this.centerView(); this.syncUI(null); this.render();
        } catch(e) { alert("È¢ÑËÆæÊçüÂùè"); }
    },
    delP(n) { if(confirm('Âà†?')) { localStorage.removeItem('PRE_'+n); this.openLoad(); } },

    async download() {
        const name = prompt("Êñá‰ª∂Âêç", "Cover") || "Cover";
        const type = document.getElementById('dl-type').value;
        const start = parseInt(document.getElementById('dl-start').value);
        const count = parseInt(document.getElementById('dl-count').value);
        
        document.getElementById('loader').style.display='flex';
        this.sel=null; this.render();
        const ec=document.createElement('canvas'), ex=ec.getContext('2d'), oc=this.ctx, ov=this.cvs;
        this.ctx=ex; this.cvs=ec;

        try {
            if(type==='zip') {
                const zip=new JSZip();
                for(let i=0;i<count;i++) { this.render(true, start+i); const b=await new Promise(r=>ec.toBlob(r,'image/jpeg',0.95)); zip.file(`${name}_${start+i}.jpg`, b); }
                saveAs(await zip.generateAsync({type:"blob"}), `${name}.zip`);
            } else {
                for(let i=0;i<count;i++) { this.render(true, start+i); await new Promise(r=>ec.toBlob(b=>{saveAs(b, `${name}_${start+i}.jpg`);r()},'image/jpeg',0.95)); }
            }
        } catch(e){alert("Error")}
        
        this.ctx=oc; this.cvs=ov; document.getElementById('loader').style.display='none'; this.render();
    }
};

app.init();
</script>
</body>
</html>
