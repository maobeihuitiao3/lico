<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixboard Pro - ç»å…¸æ’ç‰ˆç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Liu+Jian+Mao+Cao&family=Long+Cang&family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700;900&family=Noto+Serif+SC:wght@700&family=ZCOOL+KuaiLe&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+XiaoWei&family=Zhi+Mang+Xing&family=Bangers&family=Fredoka:wght@600&family=Righteous&family=Lobster&family=Alfa+Slab+One&family=Russo+One&display=swap" rel="stylesheet">

    <style>
        :root {
            --aurora-bg: 
                radial-gradient(at 0% 0%, hsla(253,16%,90%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(260, 100%, 85%, 1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(200, 100%, 85%, 1) 0, transparent 50%),
                radial-gradient(at 0% 50%, hsla(300, 100%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 100% 100%, hsla(240, 100%, 85%, 1) 0, transparent 50%);
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --primary: #6c5ce7;
            --text-main: #2d3436;
            --text-sub: #636e72;
        }

        body { 
            margin: 0; height: 100vh; display: flex; 
            background-color: #ffffff;
            background-image: var(--aurora-bg);
            background-size: 200% 200%;
            animation: auroraMove 15s ease infinite alternate;
            color: var(--text-main); font-family: "Inter", sans-serif; 
            overflow: hidden; user-select: none;
        }

        @keyframes auroraMove { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }
        * { box-sizing: border-box; outline: none; }

        /* å·¦ä¾§é¢æ¿ - ç»å…¸å¸ƒå±€ */
        .sidebar {
            width: 360px; background: var(--glass);
            backdrop-filter: blur(25px); border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; z-index: 100;
            box-shadow: 10px 0 30px rgba(0,0,0,0.03);
        }
        .header { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 20px; font-weight: 800; color: #2d3436; letter-spacing: -0.5px; }
        .brand span { color: var(--primary); background: rgba(108, 92, 231, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 11px; vertical-align: middle; margin-left: 4px; }

        .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .content::-webkit-scrollbar { width: 0; }

        /* å¡ç‰‡ - æ›´ç´§å‡‘ */
        .card { background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.6); border-radius: 12px; padding: 14px; transition: 0.2s; }
        .card.active { background: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(108, 92, 231, 0.1); transform: translateX(2px); }
        .card-title { font-size: 11px; font-weight: 700; color: #b2bec3; text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        .row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .row label { font-size: 12px; width: 40px; color: #636e72; flex-shrink: 0; font-weight: 600; }
        
        input, select {
            background: rgba(255,255,255,0.8); border: 1px solid #dfe6e9; color: #2d3436;
            padding: 0 8px; border-radius: 6px; font-size: 12px; width: 100%;
            transition: 0.2s; height: 30px;
        }
        input:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.15); }
        
        input[type="color"] { padding: 0; width: 30px; min-width: 30px; cursor: pointer; border: 2px solid #fff; overflow: hidden; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input[type="range"] { -webkit-appearance: none; height: 4px; background: rgba(0,0,0,0.1); padding: 0; border: none; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.1s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        button {
            background: #fff; border: 1px solid rgba(0,0,0,0.1); color: #636e72;
            padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;
            transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px; justify-content: center;
        }
        button:hover { border-color: var(--primary); color: var(--primary); background: #fdfdff; }
        
        button.primary {
            background: var(--primary-grad); border: none; color: white; width: 100%; padding: 10px;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3); font-size: 13px;
        }
        button.primary:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4); color: #fff; }
        button.icon-only { width: 32px; padding: 0; font-size: 16px; }

        .palette { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;}
        .dot { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s; }
        .dot:hover { transform: scale(1.2); z-index: 2; }

        /* è§†å£ */
        .viewport {
            flex: 1; position: relative; overflow: hidden;
            background: transparent;
            background-image: radial-gradient(rgba(108, 92, 231, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: grab;
        }
        .viewport:active { cursor: grabbing; }
        
        canvas { 
            display: block; background: #fff; border-radius: 2px; 
            box-shadow: 0 20px 60px -10px rgba(50, 50, 93, 0.15), 0 10px 20px -10px rgba(0, 0, 0, 0.1);
        }

        .drop-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.85);
            border: 6px dashed var(--primary); z-index: 999;
            display: none; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 800; color: var(--primary); backdrop-filter: blur(10px);
        }
        
        .empty-tip { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; pointer-events:none; opacity:0.6; color:#2d3436; }
        .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 1000; display: none; flex-direction:column; justify-content: center; align-items: center; color:#2d3436; font-weight:bold;}

        /* å³ä¸Šè§’æ‚¬æµ® */
        .top-actions {
            position: absolute; top: 20px; right: 20px; z-index: 200;
            display: flex; gap: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.6);
            align-items: center;
        }

        /* å¼¹çª— */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: #fff; width: 380px; padding: 24px; border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popIn 0.2s ease;
        }
        @keyframes popIn { from {transform:scale(0.95); opacity:0} to {transform:scale(1); opacity:1} }
        .preset-list { max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-top: 15px;}
        .preset-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
    </style>
</head>
<body>

<!-- é¢„è®¾å¼¹çª— -->
<div class="modal-mask" id="save-modal">
    <div class="modal">
        <h3 style="margin:0 0 15px 0; font-size:16px;">ä¿å­˜é¢„è®¾</h3>
        <input type="text" id="preset-name-input" placeholder="è¾“å…¥é¢„è®¾åç§°" style="height:40px; margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button onclick="app.closeModal('save')" style="flex:1">å–æ¶ˆ</button>
            <button class="primary" onclick="app.confirmSave()" style="flex:1">ç¡®è®¤ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-mask" id="load-modal">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:16px;">è¯»å–é¢„è®¾</h3>
            <span onclick="app.closeModal('load')" style="cursor:pointer; font-size:18px;">Ã—</span>
        </div>
        <div class="preset-list" id="preset-list"></div>
    </div>
</div>

<div class="drop-overlay" id="drop-overlay">ğŸ“‚ æ¾å¼€é¼ æ ‡æ·»åŠ å›¾ç‰‡</div>

<!-- å³ä¸Šè§’ï¼šå¯¼å‡º -->
<div class="top-actions">
    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
        <span style="font-size:10px; color:#b2bec3; font-weight:bold;">EXPORT</span>
        <div style="display:flex; gap:4px; font-size:12px;">
            <input type="number" id="dl-start" value="1" oninput="app.render()" style="width:32px; height:18px; padding:0; text-align:center; border:none; background:transparent;">
            <span style="color:#d1d5db; font-size:12px;">-</span>
            <input type="number" id="dl-count" value="5" style="width:32px; height:18px; padding:0; text-align:center; border:none; background:transparent;">
        </div>
    </div>
    <div style="width:1px; height:24px; background:rgba(0,0,0,0.1);"></div>
    <select id="dl-type" style="width:100px; border:none; background:transparent; font-weight:600; color:#636e72;">
        <option value="single">é€å¼ ä¸‹è½½</option>
        <option value="zip">æ‰“åŒ… ZIP</option>
    </select>
    <button class="primary" onclick="app.download()">å¯¼å‡ºæ–‡ä»¶</button>
</div>

<div class="sidebar">
    <div class="header">
        <div class="brand">Mixboard <span>PRO</span></div>
        <div style="display:flex; gap:5px;">
            <button class="icon-only" onclick="app.undo()" title="æ’¤å›">â†©</button>
            <button class="icon-only" onclick="app.redo()" title="é‡åš">â†ª</button>
            <button onclick="app.openSave()" title="ä¿å­˜">ğŸ’¾</button>
            <button onclick="app.reset(true)" title="é‡ç½®">â†»</button>
        </div>
    </div>
    
    <div class="content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: -8px;">
            <label style="font-size:11px; font-weight:700; color:#b2bec3;">QUICK ACTIONS</label>
            <button onclick="app.openLoad()" style="padding:4px 10px; font-size:11px;">ğŸ“‚ è¯»å–é¢„è®¾</button>
        </div>
        
        <div style="font-size:10px; color:#999; line-height:1.4; background:rgba(0,0,0,0.02); padding:6px; border-radius:6px;">
            æç¤º: ä¿å­˜é¢„è®¾ä¸åŒ…å«èƒŒæ™¯å›¾
        </div>

        <!-- 1. å…¨å±€ -->
        <div class="card" id="p-global">
            <div class="card-title">
                <span>ç”»å¸ƒ & åº•è‰²</span>
                <select id="ratio-preset" onchange="app.applyRatio(this.value)" style="width:80px; height:20px; padding:0; border:none; background:transparent; text-align:right;">
                    <option value="custom">è‡ªå®šä¹‰</option>
                    <option value="750,1000">3:4 å°çº¢ä¹¦</option>
                    <option value="720,1280">9:16 æŠ–éŸ³</option>
                    <option value="1280,720">16:9 æ¨ªå±</option>
                </select>
            </div>
            <div class="row">
                <input type="number" id="cw" value="750" onchange="app.pushHistory(); app.resizeBoard()"> 
                <span>Ã—</span> 
                <input type="number" id="ch" value="1000" onchange="app.pushHistory(); app.resizeBoard()">
            </div>
            <div class="row">
                <label>åº•æ¡</label>
                <input type="color" id="barC" value="#ffffff" onchange="app.pushHistory()" oninput="app.render()">
                <input type="range" id="barH" max="500" value="220" onmousedown="app.pushHistory()" oninput="app.render()">
            </div>
            <div class="row">
                <label>ç¾½åŒ–</label>
                <input type="range" id="barF" max="150" value="0" title="è¾¹ç¼˜ç¾½åŒ–" onmousedown="app.pushHistory()" oninput="app.render()">
            </div>
            
            <div style="margin-top:10px;">
                <div class="palette" id="smart-colors">
                    <div class="dot" style="background:#ffffff" onclick="app.applyColor('#ffffff')"></div>
                    <div class="dot" style="background:#2d3436" onclick="app.applyColor('#2d3436')"></div>
                    <div class="dot" style="background:#b2bec3" onclick="app.applyColor('#b2bec3')"></div>
                    <div class="dot" style="background:#ff7675" onclick="app.applyColor('#ff7675')"></div>
                    <div class="dot" style="background:#74b9ff" onclick="app.applyColor('#74b9ff')"></div>
                    <div class="dot" style="background:#a29bfe" onclick="app.applyColor('#a29bfe')"></div>
                </div>
            </div>

            <button class="primary" style="margin-top:12px;" onclick="document.getElementById('uplogo').click()">ğŸ–¼ï¸ æ›¿æ¢ Logo</button>
            <input type="file" id="uplogo" hidden accept="image/*" onchange="app.loadImg(this, 'logo')">
        </div>

        <!-- 2. æ–‡å­— -->
        <div class="card" id="p-txt">
            <div class="card-title">
                <span>æ–‡å­—æ ·å¼</span>
                <button onclick="app.addText()" style="padding:4px 8px; font-size:10px;">+ æ·»åŠ </button>
            </div>
            <input type="text" id="t-val" placeholder="é€‰æ‹©æ–‡å­—..." onchange="app.pushHistory()" oninput="app.updateSel('val',this.value)" style="margin-bottom:10px; font-weight:bold;">
            <div class="row">
                <select id="t-font" onchange="app.pushHistory(); app.updateSel('font',this.value)">
                    <optgroup label="ä¸­æ–‡å­—ä½“">
                        <option value="'Ma Shan Zheng'">æ±Ÿæ¹–ä½“ (é»˜è®¤)</option>
                        <option value="'Zhi Mang Xing'">å¿—è½è¡Œä¹¦</option>
                        <option value="'Long Cang'">é¾™è‹ç‹‚è‰</option>
                        <option value="'ZCOOL QingKe HuangYou'">ç«™é…·é»„æ²¹</option>
                        <option value="'Noto Sans SC'">æ€æºé»‘ä½“</option>
                        <option value="'Noto Serif SC'">æ€æºå®‹ä½“</option>
                    </optgroup>
                    <optgroup label="è‹±æ•°é£æ ¼">
                        <option value="'Bangers'">Bangers æ¼«ç”»</option>
                        <option value="'Righteous'">Righteous ç§‘å¹»</option>
                        <option value="'Lobster'">Lobster è‰ºæœ¯</option>
                        <option value="'Russo One'">Russo ç¡¬æœ—</option>
                    </optgroup>
                </select>
            </div>
            <div class="row"><label>å­—å·</label><input type="range" min="20" max="400" id="t-s" onmousedown="app.pushHistory()" oninput="app.updateSel('s',this.value)"></div>
            <div class="row"><label>ç²—ç»†</label><input type="range" min="100" max="900" id="t-w" onmousedown="app.pushHistory()" oninput="app.updateSel('w',this.value)"></div>
            <div class="row">
                <label>é¢œè‰²</label><input type="color" id="t-c" onchange="app.pushHistory()" oninput="app.updateSel('c',this.value)">
                <label style="margin-left:auto; width:auto;">å­—è·</label><input type="range" min="-10" max="50" id="t-sp" onmousedown="app.pushHistory()" oninput="app.updateSel('sp',this.value)">
            </div>
            <div class="row">
                <label>é˜´å½±</label><input type="color" id="t-sc" onchange="app.pushHistory()" oninput="app.updateSel('sc',this.value)">
                <input type="range" max="30" id="t-sb" onmousedown="app.pushHistory()" oninput="app.updateSel('sb',this.value)">
            </div>
        </div>

        <!-- 3. åºå· -->
        <div class="card" id="p-num">
            <div class="card-title">åºå·æ ·å¼</div>
            <div class="row">
                <select id="n-st" onchange="app.pushHistory(); app.updateSel('st',this.value)">
                    <option value="plain">çº¯æ•°å­—</option>
                    <option value="circle">åœ†åœˆ â‘ </option>
                    <option value="box">æ–¹å— [1]</option>
                    <option value="underline">ä¸‹åˆ’çº¿ _1_</option>
                </select>
                <input type="color" id="n-c" onchange="app.pushHistory()" oninput="app.updateSel('c',this.value)">
            </div>
            <div class="row">
                <select id="n-font" onchange="app.pushHistory(); app.updateSel('font',this.value)">
                    <option value="'Ma Shan Zheng'">æ±Ÿæ¹–ä½“ (é»˜è®¤)</option>
                    <option value="'Arial'">ç³»ç»Ÿæ•°å­—</option>
                </select>
            </div>
            <div class="row"><label>å­—å·</label><input type="range" min="20" max="250" id="n-s" onmousedown="app.pushHistory()" oninput="app.updateSel('s',this.value)"></div>
            <div class="row"><label>ç²—ç»†</label><input type="range" min="100" max="900" id="n-w" onmousedown="app.pushHistory()" oninput="app.updateSel('w',this.value)"></div>
            <div class="row">
                <label>é˜´å½±</label><input type="color" id="n-sc" onchange="app.pushHistory()" oninput="app.updateSel('sc',this.value)">
                <input type="range" max="30" id="n-sb" onmousedown="app.pushHistory()" oninput="app.updateSel('sb',this.value)">
            </div>
        </div>
    </div>
</div>

<div class="viewport" id="viewport" tabindex="0">
    <canvas id="cvs"></canvas>
    <div class="empty-tip" id="empty-tip">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ“‚</div>
        <div style="font-weight:700; font-size:16px;">æ‹–å…¥å›¾ç‰‡å¼€å§‹è®¾è®¡</div>
    </div>
</div>

<div class="loader" id="loader">
    <div style="font-size:24px; font-weight:800; margin-bottom:10px;">Rendering...</div>
</div>

<script>
const DEF_LOGO = "https://pic1.imgdb.cn/item/69367cdf2a
