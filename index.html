<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixboard Pro - å®Œç¾ä¿®å¤ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Liu+Jian+Mao+Cao&family=Long+Cang&family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700;900&family=Noto+Serif+SC:wght@700&family=ZCOOL+KuaiLe&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+XiaoWei&family=Zhi+Mang+Xing&family=Bangers&family=Fredoka:wght@600&family=Righteous&family=Lobster&family=Alfa+Slab+One&family=Russo+One&display=swap" rel="stylesheet">

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --primary: #6c5ce7;
            --primary-grad: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            --text-main: #2d3436;
            --text-sub: #636e72;
        }

        /* å¸ƒå±€é‡ç½® */
        * { box-sizing: border-box; outline: none; user-select: none; }
        
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; /* é”æ­»æ»šåŠ¨æ¡ */
            font-family: "Inter", sans-serif;
            background: #fff;
            color: var(--text-main);
        }

        /* === èƒŒæ™¯æå…‰å±‚ === */
        #bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: 
                radial-gradient(at 0% 0%, hsla(253,16%,90%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(260, 100%, 85%, 1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(200, 100%, 85%, 1) 0, transparent 50%),
                radial-gradient(at 0% 50%, hsla(300, 100%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 100% 100%, hsla(240, 100%, 85%, 1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: aurora 15s ease infinite alternate;
        }
        @keyframes aurora { 0% {background-position:0% 0%} 100% {background-position:100% 100%} }

        /* === ä¸»åº”ç”¨å®¹å™¨ (Flexå¸ƒå±€) === */
        #app-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            display: flex;
        }

        /* å·¦ä¾§é¢æ¿ */
        .sidebar {
            width: 380px; height: 100%; flex-shrink: 0;
            background: var(--glass);
            backdrop-filter: blur(30px);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.02);
        }
        .header { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 20px; font-weight: 800; color: #2d3436; }
        .brand span { color: var(--primary); background: rgba(108, 92, 231, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; vertical-align: middle; }

        .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .content::-webkit-scrollbar { width: 0; }

        /* ä¸­é—´å·¥ä½œåŒº (Viewport) */
        .viewport {
            flex: 1; height: 100%; position: relative; overflow: hidden;
            background-image: radial-gradient(rgba(108, 92, 231, 0.1) 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            cursor: grab;
        }
        .viewport:active { cursor: grabbing; }

        /* ç”»å¸ƒ Canvas (ç»å¯¹å®šä½æ’‘æ»¡ Viewport) */
        canvas {
            display: block; width: 100%; height: 100%;
        }

        /* === UI ç»„ä»¶ === */
        /* å³ä¸Šè§’å¯¼å‡ºæ¡ */
        .top-actions {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px; background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.6);
            align-items: center;
        }

        .card { background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.6); border-radius: 12px; padding: 16px; transition: 0.2s; }
        .card.active { background: #fff; border-color: var(--primary); box-shadow: 0 8px 24px rgba(108, 92, 231, 0.12); transform: translateX(4px); }
        .card-title { font-size: 11px; font-weight: 700; color: #b2bec3; text-transform: uppercase; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }

        .row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .row label { font-size: 12px; width: 40px; color: #636e72; flex-shrink: 0; font-weight: 600; }
        
        input, select {
            background: rgba(255,255,255,0.8); border: 1px solid #dfe6e9; color: #2d3436;
            padding: 0 10px; border-radius: 6px; font-size: 13px; width: 100%;
            transition: 0.2s; height: 32px;
        }
        input:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.15); }
        
        input[type="color"] { padding: 0; width: 32px; min-width: 32px; cursor: pointer; border: 2px solid #fff; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 6px; }
        input[type="range"] { -webkit-appearance: none; height: 4px; background: rgba(0,0,0,0.1); padding: 0; border: none; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.1s; }
        
        button {
            background: rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.1); color: #636e72;
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;
            transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; justify-content: center;
        }
        button:hover { border-color: var(--primary); color: var(--primary); background: #fff; }
        
        /* ä¿®å¤æŒ‰é’®æ–‡å­—é¢œè‰²é—®é¢˜ */
        button.primary {
            background: var(--primary-grad); border: none; color: white !important; width: 100%; padding: 12px;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        button.primary:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4); }
        
        button.icon-only { width: 32px; padding: 0; font-size: 16px; }
        button.danger { color: #e74c3c; border-color: #fab1a0; background: #fff5f5; }

        .palette { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;}
        .dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; }
        .dot:hover { transform: scale(1.15); z-index: 2; }

        /* æ‹–æ‹½æç¤º */
        .drop-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.8);
            border: 8px dashed var(--primary); z-index: 999;
            display: none; align-items: center; justify-content: center;
            font-size: 32px; font-weight: 800; color: var(--primary); backdrop-filter: blur(10px);
        }
        
        .empty-tip { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; pointer-events:none; opacity:0.6; color:#2d3436; }
        .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; display: none; flex-direction:column; justify-content: center; align-items: center; color:#2d3436; font-weight:bold;}

        /* é¢„è®¾å¼¹çª— */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: #fff; width: 400px; max-height: 80vh;
            border-radius: 20px; padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; gap: 15px;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-head { font-size: 18px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { overflow-y: auto; max-height: 50vh; display: flex; flex-direction: column; gap: 10px; }
        .preset-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; transition: 0.2s; }
        .preset-item:hover { background: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(108, 92, 231, 0.1); }
    </style>
</head>
<body>

<div id="bg-layer"></div>

<!-- æ‹–æ‹½è¦†ç›–å±‚ -->
<div class="drop-overlay" id="drop-overlay">ğŸ“‚ æ¾å¼€é¼ æ ‡æ·»åŠ å›¾ç‰‡</div>

<!-- å³ä¸Šè§’å¯¼å‡º -->
<div class="top-actions">
    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
        <span style="font-size:10px; color:#b2bec3; font-weight:bold;">EXPORT</span>
        <div style="display:flex; gap:4px; font-size:12px;">
            <input type="number" id="dl-start" value="1" title="èµ·å§‹å·" oninput="app.render()" style="width:36px; height:20px; padding:0; text-align:center; border:none; background:transparent;">
            <span style="color:#d1d5db; font-size:12px;">-</span>
            <input type="number" id="dl-count" value="5" title="æ•°é‡" style="width:36px; height:20px; padding:0; text-align:center; border:none; background:transparent;">
        </div>
    </div>
    <div style="width:1px; height:24px; background:rgba(0,0,0,0.1);"></div>
    <select id="dl-type" style="width:110px; background:transparent; border:none; font-weight:600; color:#4b5563;">
        <option value="single">é€å¼ ä¸‹è½½</option>
        <option value="zip">æ‰“åŒ… ZIP</option>
    </select>
    <button class="primary" onclick="app.download()">å¯¼å‡ºæ–‡ä»¶</button>
</div>

<!-- å¼¹çª— -->
<div class="modal-mask" id="save-modal">
    <div class="modal">
        <div class="modal-head">ä¿å­˜é¢„è®¾ <span onclick="app.closeModal('save')" style="cursor:pointer; color:#aaa;">Ã—</span></div>
        <input type="text" id="preset-name-input" placeholder="è¾“å…¥é¢„è®¾åç§°" style="height:44px;">
        <button class="primary" onclick="app.confirmSave()">ç¡®è®¤ä¿å­˜</button>
    </div>
</div>
<div class="modal-mask" id="load-modal">
    <div class="modal">
        <div class="modal-head">è¯»å–é¢„è®¾ <span onclick="app.closeModal('load')" style="cursor:pointer; color:#aaa;">Ã—</span></div>
        <div class="modal-body" id="preset-list"></div>
    </div>
</div>

<div id="app-container">
    <div class="sidebar">
        <div class="header">
            <div class="brand">Mixboard <span>PRO</span></div>
            <div style="display:flex; gap:6px;">
                <button class="icon-only" onclick="app.undo()" title="æ’¤å›">â†©</button>
                <button class="icon-only" onclick="app.redo()" title="é‡åš">â†ª</button>
                <button onclick="app.openSave()" title="ä¿å­˜">ğŸ’¾</button>
                <button onclick="app.reset(true)" title="é‡ç½®">â†»</button>
            </div>
        </div>
        
        <div class="content">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: -10px;">
                <label style="font-size:11px; font-weight:700; color:#b2bec3;">QUICK ACTIONS</label>
                <button onclick="app.openLoad()" style="padding:6px 12px; font-size:11px; background:rgba(108,92,231,0.08); color:var(--primary); border:none;">ğŸ“‚ è¯»å–é¢„è®¾</button>
            </div>

            <!-- 1. å…¨å±€ -->
            <div class="card" id="p-global">
                <div class="card-title">
                    <span>ç”»å¸ƒ & åº•è‰²</span>
                    <select id="ratio-preset" onchange="app.applyRatio(this.value)" style="width:90px; height:24px; padding:0; border:none; background:transparent; text-align:right;">
                        <option value="custom">è‡ªå®šä¹‰</option>
                        <option value="750,1000">3:4 å°çº¢ä¹¦</option>
                        <option value="720,1280">9:16 æŠ–éŸ³</option>
                        <option value="1280,720">16:9 æ¨ªå±</option>
                        <option value="1080,1080">1:1 æ­£æ–¹å½¢</option>
                    </select>
                </div>
                <div class="row">
                    <input type="number" id="cw" value="750" onchange="app.pushHistory(); app.resizeBoard()"> 
                    <span>Ã—</span> 
                    <input type="number" id="ch" value="1000" onchange="app.pushHistory(); app.resizeBoard()">
                </div>
                <div class="row">
                    <label>åº•æ¡</label>
                    <input type="color" id="barC" value="#ffffff" onchange="app.pushHistory()" oninput="app.render()">
                    <input type="range" id="barH" max="500" value="220" onmousedown="app.pushHistory()" oninput="app.render()">
                </div>
                <div class="row">
                    <label>ç¾½åŒ–</label>
                    <input type="range" id="barF" max="150" value="0" title="è¾¹ç¼˜ç¾½åŒ–ç¨‹åº¦" onmousedown="app.pushHistory()" oninput="app.render()">
                </div>
                
                <div style="margin-top:12px;">
                    <label style="font-size:11px; color:#9ca3af; font-weight:700;">é…è‰²æ¨è</label>
                    <div class="palette" id="smart-colors">
                        <div class="dot" style="background:#ffffff" onclick="app.applyColor('#ffffff')"></div>
                        <div class="dot" style="background:#2d3436" onclick="app.applyColor('#2d3436')"></div>
                        <div class="dot" style="background:#b2bec3" onclick="app.applyColor('#b2bec3')"></div>
                        <div class="dot" style="background:#ff7675" onclick="app.applyColor('#ff7675')"></div>
                        <div class="dot" style="background:#74b9ff" onclick="app.applyColor('#74b9ff')"></div>
                        <div class="dot" style="background:#a29bfe" onclick="app.applyColor('#a29bfe')"></div>
                        <div class="dot" style="background:#00cec9" onclick="app.applyColor('#00cec9')"></div>
                        <div class="dot" style="background:#fd79a8" onclick="app.applyColor('#fd79a8')"></div>
                    </div>
                </div>

                <button class="primary" style="margin-top:15px;" onclick="document.getElementById('uplogo').click()">ğŸ–¼ï¸ æ›¿æ¢ Logo</button>
                <input type="file" id="uplogo" hidden accept="image/*" onchange="app.loadImg(this, 'logo')">
            </div>

            <!-- 2. æ–‡å­— -->
            <div class="card" id="p-txt">
                <div class="card-title">
                    <span>æ–‡å­—æ ·å¼</span>
                    <button onclick="app.addText()" style="padding:4px 8px; font-size:10px;">+ æ·»åŠ </button>
                </div>
                <input type="text" id="t-val" placeholder="é€‰æ‹©æ–‡å­—..." onchange="app.pushHistory()" oninput="app.updateSel('val',this.value)" style="margin-bottom:10px; font-weight:bold;">
                <div class="row">
                    <select id="t-font" onchange="app.pushHistory(); app.updateSel('font',this.value)">
                        <optgroup label="ä¸­æ–‡å­—ä½“">
                            <option value="'Ma Shan Zheng'">æ±Ÿæ¹–ä½“ (é»˜è®¤)</option>
                            <option value="'Zhi Mang Xing'">å¿—è½è¡Œä¹¦</option>
                            <option value="'Long Cang'">é¾™è‹ç‹‚è‰</option>
                            <option value="'ZCOOL QingKe HuangYou'">ç«™é…·é»„æ²¹</option>
                            <option value="'Noto Sans SC'">æ€æºé»‘ä½“</option>
                            <option value="'Noto Serif SC'">æ€æºå®‹ä½“</option>
                        </optgroup>
                        <optgroup label="è‹±æ•°é£æ ¼">
                            <option value="'Bangers'">Bangers æ¼«ç”»</option>
                            <option value="'Righteous'">Righteous ç§‘å¹»</option>
                            <option value="'Lobster'">Lobster è‰ºæœ¯</option>
                            <option value="'Russo One'">Russo ç¡¬æœ—</option>
                        </optgroup>
                    </select>
                </div>
                <div class="row"><label>å­—å·</label><input type="range" min="20" max="400" id="t-s" onmousedown="app.pushHistory()" oninput="app.updateSel('s',this.value)"></div>
                <div class="row"><label>ç²—ç»†</label><input type="range" min="100" max="900" id="t-w" onmousedown="app.pushHistory()" oninput="app.updateSel('w',this.value)"></div>
                <div class="row">
                    <label>é¢œè‰²</label><input type="color" id="t-c" onchange="app.pushHistory()" oninput="app.updateSel('c',this.value)">
                    <label style="margin-left:auto; width:auto;">å­—è·</label><input type="range" min="-10" max="50" id="t-sp" onmousedown="app.pushHistory()" oninput="app.updateSel('sp',this.value)">
                </div>
                <div class="row">
                    <label>é˜´å½±</label><input type="color" id="t-sc" onchange="app.pushHistory()" oninput="app.updateSel('sc',this.value)">
                    <input type="range" max="30" id="t-sb" onmousedown="app.pushHistory()" oninput="app.updateSel('sb',this.value)">
                </div>
            </div>

            <!-- 3. åºå· -->
            <div class="card" id="p-num">
                <div class="card-title">åºå·æ ·å¼</div>
                <div class="row">
                    <select id="n-st" onchange="app.pushHistory(); app.updateSel('st',this.value)">
                        <option value="plain">çº¯æ•°å­—</option>
                        <option value="circle">åœ†åœˆ â‘ </option>
                        <option value="box">æ–¹å— [1]</option>
                        <option value="underline">ä¸‹åˆ’çº¿ _1_</option>
                    </select>
                    <input type="color" id="n-c" onchange="app.pushHistory()" oninput="app.updateSel('c',this.value)">
                </div>
                <div class="row">
                    <select id="n-font" onchange="app.pushHistory(); app.updateSel('font',this.value)">
                        <option value="'Ma Shan Zheng'">æ±Ÿæ¹–ä½“ (é»˜è®¤)</option>
                        <option value="'Arial'">ç³»ç»Ÿæ•°å­—</option>
                    </select>
                </div>
                <div class="row"><label>å­—å·</label><input type="range" min="20" max="250" id="n-s" onmousedown="app.pushHistory()" oninput="app.updateSel('s',this.value)"></div>
                <div class="row"><label>ç²—ç»†</label><input type="range" min="100" max="900" id="n-w" onmousedown="app.pushHistory()" oninput="app.updateSel('w',this.value)"></div>
                <div class="row">
                    <label>é˜´å½±</label><input type="color" id="n-sc" onchange="app.pushHistory()" oninput="app.updateSel('sc',this.value)">
                    <input type="range" id="n-sb" max="30" onmousedown="app.pushHistory()" oninput="app.updateSel('sb',this.value)">
                </div>
            </div>
        </div>
    </div>

    <!-- è§†å£ -->
    <div class="viewport" id="viewport" tabindex="0">
        <canvas id="cvs"></canvas>
        <div class="empty-tip" id="empty-tip">
            <div style="font-size:48px; margin-bottom:16px;">ğŸ“‚</div>
            <div style="font-weight:700; font-size:18px; color:#2d3436;">æ‹–å…¥å›¾ç‰‡å¼€å§‹è®¾è®¡</div>
            <div style="color:#636e72; font-size:13px; margin-top:8px;">ç©ºæ ¼+æ‹–æ‹½å¹³ç§» | Backspaceåˆ é™¤</div>
        </div>
    </div>
</div>

<div class="loader" id="loader">
    <div style="font-size:24px; font-weight:800; margin-bottom:10px;">Rendering...</div>
    <div style="opacity:0.7">æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡</div>
</div>

<script>
const DEF_LOGO_URL = "https://pic1.imgdb.cn/item/69367cdf2a4ee13cb9508e34.png";

function hexToRgba(hex, alpha) {
    let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}
function invertColor(hex) {
    if(hex.indexOf('rgb') > -1) return '#000';
    const r = parseInt(hex.substr(1,2),16), g = parseInt(hex.substr(3,2),16), b = parseInt(hex.substr(5,2),16);
    return (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000000' : '#ffffff';
}

const app = {
    view: { x:0, y:0, zoom:0.65 },
    board: { w:750, h:1000 },
    items: [],
    history: [], ptr: -1,
    sel: null, mode: null, lastP: {x:0,y:0}, initV: {},
    cvs: document.getElementById('cvs'),
    ctx: document.getElementById('cvs').getContext('2d'),

    init() {
        this.resizeViewport();
        window.addEventListener('resize', () => this.resizeViewport());
        
        window.addEventListener('keydown', e => { 
            const active = document.activeElement;
            const isInput = active.tagName === 'INPUT' || active.tagName === 'SELECT' || active.tagName === 'TEXTAREA';
            
            if(e.code==='Space' && !isInput) document.getElementById('viewport').style.cursor='grab'; 
            if((e.code==='Backspace' || e.code==='Delete') && !isInput) this.deleteSelection();
            if((e.ctrlKey||e.metaKey) && e.key==='z' && !isInput) { e.preventDefault(); this.undo(); }
            if((e.ctrlKey||e.metaKey) && e.key==='y' && !isInput) { e.preventDefault(); this.redo(); }
        });
        window.addEventListener('keyup', e => { document.getElementById('viewport').style.cursor='default'; });

        this.reset();
        this.bindEvents();
        document.fonts.ready.then(() => this.render());
    },

    pushHistory() {
        if(this.historyPtr < this.history.length - 1) {
            this.history = this.history.slice(0, this.historyPtr + 1);
        }
        const state = JSON.stringify({
            items: this.items.map(x=>{const c={...x}; delete c.img; delete c._box; return c;}),
            board: this.board,
            bar: {
                h: document.getElementById('barH').value,
                f: document.getElementById('barF').value,
                c: document.getElementById('barC').value
            }
        });
        if(this.history.length > 0 && this.history[this.history.length-1] === state) return;
        this.history.push(state);
        this.historyPtr++;
        if(this.history.length > 30) { this.history.shift(); this.historyPtr--; }
    },

    undo() {
        if(this.historyPtr > 0) {
            this.historyPtr--;
            this.restoreState(this.history[this.historyPtr]);
        }
    },

    redo() {
        if(this.historyPtr < this.history.length - 1) {
            this.historyPtr++;
            this.restoreState(this.history[this.historyPtr]);
        }
    },

    restoreState(json) {
        const data = JSON.parse(json);
        this.board = data.board;
        document.getElementById('cw').value = this.board.w;
        document.getElementById('ch').value = this.board.h;
        document.getElementById('barH').value = data.bar.h;
        document.getElementById('barF').value = data.bar.f || 0;
        document.getElementById('barC').value = data.bar.c;

        const currentImgs = {};
        this.items.forEach(i => { if(i.img) currentImgs[i.id || i.z] = i.img; });

        this.items = data.items.map(o => {
            if(o.type==='img' || o.id==='logo') {
                if(currentImgs[o.id || o.z]) o.img = currentImgs[o.id || o.z];
                else if(o.isLogo) { 
                    const i=new Image(); i.crossOrigin="Anonymous"; i.src=DEF_LOGO_URL; i.onload=()=>this.render(); o.img=i; 
                }
            }
            return o;
        });
        
        this.sel = null; 
        this.syncUI();
        this.render();
    },

    reset(force) {
        if(force && !confirm("ç¡®å®šé‡ç½®ï¼Ÿ")) return;
        
        this.board = { w: 750, h: 1000 };
        document.getElementById('cw').value = 750;
        document.getElementById('ch').value = 1000;
        document.getElementById('barH').value = 220;
        document.getElementById('barC').value = "#ffffff";
        document.getElementById('barF').value = 0;

        this.items = [
            { type:'img', id:'logo', isLogo:true, x:650, y:800, w:200, h:80, s:1, r:0, z:200 },
            { type:'txt', id:'title', val:'èµ¤å½± Â· æŠ˜å å°åˆ€', x:375, y:880, font:"'Ma Shan Zheng'", s:80, w:400, sp:0, c:'#000000', sc:'#000000', sb:0, r:0, z:201 },
            { type:'num', id:'num', val:1, x:690, y:950, font:"'Ma Shan Zheng'", st:'plain', s:80, w:400, c:'#000000', sc:'#000000', sb:0, r:0, z:202 }
        ];

        const img = new Image();
        img.crossOrigin = "Anonymous"; 
        img.onload = () => { 
            const l = this.items.find(x=>x.id==='logo'); 
            l.img = img; l.w = img.width; l.h = img.height; l.s = 200/img.width; 
            this.render(); 
            this.pushHistory();
        };
        img.src = DEF_LOGO_URL;

        this.history = []; this.historyPtr = -1;
        this.centerView();
        this.syncUI();
    },

    resizeViewport() {
        this.cvs.width = document.getElementById('viewport').clientWidth;
        this.cvs.height = document.getElementById('viewport').clientHeight;
        this.render();
    },
    
    resizeBoard() {
        this.board.w = parseInt(document.getElementById('cw').value);
        this.board.h = parseInt(document.getElementById('ch').value);
        this.render();
    },

    applyRatio(val) {
        if(val === 'custom') return;
        const [w, h] = val.split(',');
        document.getElementById('cw').value = w;
        document.getElementById('ch').value = h;
        this.pushHistory();
        this.resizeBoard();
        this.centerView();
    },

    centerView() {
        this.view.x = this.cvs.width/2;
        this.view.y = this.cvs.height/2;
        this.view.zoom = Math.min((this.cvs.width-100)/this.board.w, (this.cvs.height-100)/this.board.h);
        this.render();
    },

    deleteSelection() {
        if(this.sel) {
            this.pushHistory();
            this.items = this.items.filter(i => i !== this.sel);
            this.sel = null;
            this.render();
        }
    },

    // --- æ¸²æŸ“ ---
    render(isExport=false, numOv=null) {
        const ctx = this.ctx;
        
        if (!isExport) {
            ctx.resetTransform();
            ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
            ctx.translate(this.view.x, this.view.y);
            ctx.scale(this.view.zoom, this.view.zoom);
            ctx.translate(-this.board.w/2, -this.board.h/2);
        } else {
            this.cvs.width = this.board.w;
            this.cvs.height = this.board.h;
            ctx.resetTransform();
        }

        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, this.board.w, this.board.h);
        if(!isExport) { 
            ctx.save(); 
            ctx.shadowColor="rgba(0,0,0,0.1)"; ctx.shadowBlur=50; 
            ctx.fillStyle="#fff"; ctx.fillRect(0,0,this.board.w, this.board.h); 
            ctx.restore(); 
        }

        const list = [...this.items].sort((a,b) => a.z - b.z);
        const hasBg = list.some(x => x.type === 'img' && !x.isLogo);
        if(!isExport) document.getElementById('empty-tip').style.display = hasBg ? 'none' : 'block';

        ctx.save();
        ctx.beginPath(); ctx.rect(0,0,this.board.w, this.board.h); ctx.clip();

        list.filter(x => x.type === 'img' && !x.isLogo).forEach(o => this.drawItem(ctx, o));

        const barH = parseInt(document.getElementById('barH').value);
        const barF = parseInt(document.getElementById('barF').value);
        const barC = document.getElementById('barC').value;
        if(barH > 0) {
            if(barF > 0) {
                const g = ctx.createLinearGradient(0, this.board.h - barH - barF, 0, this.board.h - barH);
                g.addColorStop(0, hexToRgba(barC, 0));
                g.addColorStop(1, barC);
                ctx.fillStyle = g;
                ctx.fillRect(0, this.board.h - barH - barF, this.board.w, barF + 2);
            }
            ctx.fillStyle = barC;
            ctx.fillRect(0, this.board.h - barH, this.board.w, barH);
        }

        list.filter(x => !(x.type === 'img' && !x.isLogo)).forEach(o => {
            let val = null;
            if(o.type === 'num') val = (isExport && numOv !== null) ? numOv : document.getElementById('dl-start').value;
            this.drawItem(ctx, o, val);
        });

        ctx.restore();

        if(!isExport && this.mode === 'drag' && this.sel) this.drawGuides(ctx, this.sel);
        if(!isExport && this.sel) this.drawSelection(ctx, this.sel);
    },

    drawItem(ctx, o, override) {
        if(!o.w) o.w=100; if(!o.h) o.h=100;
        ctx.save();
        ctx.translate(o.x, o.y); ctx.rotate(o.r);

        if(o.sc && o.sb > 0) {
            ctx.shadowColor = o.sc; ctx.shadowBlur = parseInt(o.sb); 
            ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
        }

        let bw=0, bh=0;

        if(o.type === 'img') {
            if(o.img) {
                bw = o.w * o.s; bh = o.h * o.s;
                try { ctx.drawImage(o.img, -bw/2, -bh/2, bw, bh); } catch(e){}
            }
        } else if(o.type === 'txt') {
            ctx.fillStyle = o.c;
            const f = `${o.w} ${o.s}px ${o.font}`;
            const dim = this.drawText(ctx, o.val, f, parseInt(o.sp));
            bw = dim.w; bh = o.s * 1.1; 
        } else if(o.type === 'num') {
            const v = String(override);
            ctx.fillStyle = o.c;
            ctx.font = `${o.w} ${o.s}px ${o.font}`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            
            const m = ctx.measureText(v);
            
            if(o.st === 'plain') {
                ctx.fillText(v, 0, 0); 
                bw=m.width; bh=o.s*1.1;
            } else if(o.st === 'circle') {
                const r = o.s * 0.65;
                ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2);
                ctx.lineWidth=Math.max(2, o.s*0.05); ctx.strokeStyle=o.c; ctx.stroke();
                ctx.font = `${o.w} ${o.s*0.6}px ${o.font}`;
                ctx.fillText(v, 0, o.s*0.05); 
                bw=bh=r*2;
            } else if(o.st === 'box') {
                 ctx.font = `${o.w} ${o.s*0.7}px ${o.font}`;
                 ctx.fillRect(-o.s*0.6, -o.s*0.6, o.s*1.2, o.s*1.2);
                 ctx.fillStyle = invertColor(o.c); 
                 ctx.fillText(v, 0, o.s*0.05); bw=bh=o.s*1.2;
            } else if(o.st === 'underline') {
                 ctx.fillText(v, 0, 0);
                 ctx.fillRect(-m.width/2, o.s*0.5, m.width, Math.max(2, o.s*0.08)); 
                 bw=m.width; bh=o.s;
            }
        }
        o._box = { w: bw||50, h: bh||50 };
        ctx.restore();
    },

    drawText(ctx, txt, font, sp) {
        ctx.font = font; ctx.textAlign="center"; ctx.textBaseline="middle";
        const arr = String(txt).split('');
        let tw = 0; const ws = [];
        arr.forEach(c => { const w = ctx.measureText(c).width; ws.push(w); tw += w; });
        tw += (arr.length - 1) * sp;
        let cx = -tw / 2;
        arr.forEach((c, i) => { ctx.fillText(c, cx + ws[i]/2, 0); cx += ws[i] + sp; });
        return { w: tw };
    },

    drawSelection(ctx, o) {
        if(!o._box) return;
        ctx.save(); 
        ctx.translate(o.x, o.y); ctx.rotate(o.r);
        const w = o._box.w + 10; const h = o._box.h + 10;
        
        ctx.strokeStyle = "#6c5ce7"; ctx.lineWidth = 1.5; ctx.setLineDash([5, 3]);
        ctx.strokeRect(-w/2, -h/2, w, h);

        ctx.setLineDash([]);
        ctx.fillStyle = "#fff"; ctx.strokeStyle = "#6c5ce7"; ctx.lineWidth = 2;
        [[-w/2,-h/2], [w/2,-h/2], [-w/2,h/2], [w/2,h/2]].forEach(p => {
            ctx.beginPath(); ctx.arc(p[0], p[1], 5, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        });
        
        ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(0, h/2 + 25); ctx.strokeStyle="#6c5ce7"; ctx.stroke();
        ctx.beginPath(); ctx.arc(0, h/2 + 25, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();

        ctx.restore();
    },

    drawGuides(ctx, o) {
        const cx = this.board.w / 2; const cy = this.board.h / 2;
        const snap = 8;
        if(Math.abs(o.x - cx) < snap) { 
            o.x = cx; 
            ctx.save(); ctx.lineWidth = 1; ctx.strokeStyle = "#e84393"; ctx.setLineDash([4, 4]);
            ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, this.board.h); ctx.stroke(); ctx.restore();
        }
        if(Math.abs(o.y - cy) < snap) {
            o.y = cy;
            ctx.save(); ctx.lineWidth = 1; ctx.strokeStyle = "#e84393"; ctx.setLineDash([4, 4]);
            ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(this.board.w, cy); ctx.stroke(); ctx.restore();
        }
    },

    getPointerPos(e) {
        const rect = this.cvs.getBoundingClientRect();
        const px = e.clientX - rect.left;
        const py = e.clientY - rect.top;
        const x = (px - this.view.x) / this.view.zoom + this.board.w/2;
        const y = (py - this.view.y) / this.view.zoom + this.board.h/2;
        return { x, y };
    },

    toLocal(pt, o) {
        const dx = pt.x - o.x; const dy = pt.y - o.y;
        const c = Math.cos(-o.r); const s = Math.sin(-o.r);
        return { x: dx*c - dy*s, y: dx*s + dy*c };
    },

    bindEvents() {
        const v = document.getElementById('viewport');
        const overlay = document.getElementById('drop-overlay');

        let dragCounter = 0;
        document.addEventListener('dragenter', e => { e.preventDefault(); dragCounter++; overlay.style.display = 'flex'; });
        document.addEventListener('dragleave', e => { e.preventDefault(); dragCounter--; if(dragCounter===0) overlay.style.display = 'none'; });
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => { 
            e.preventDefault(); dragCounter=0; overlay.style.display = 'none'; 
            this.handleDrop(e);
        });

        v.addEventListener('mousedown', e => {
            const p = this.getPointerPos(e);
            
            if (e.code === 'Space' || e.button === 1) {
                this.mode = 'pan'; this.lastP = {x:e.clientX, y:e.clientY}; return;
            }

            if(this.sel && this.sel._box) {
                const l = this.toLocal(p, this.sel);
                const w = this.sel._box.w + 14; const h = this.sel._box.h + 14;
                if(Math.hypot(l.x, l.y - (h/2+25)) < 15) {
                    this.pushHistory();
                    this.mode = 'rot'; this.initV = { r: this.sel.r, ang: Math.atan2(p.y - this.sel.y, p.x - this.sel.x) }; return;
                }
                if(Math.abs(l.x) > w/2-15 && Math.abs(l.y) > h/2-15) {
                    this.pushHistory();
                    this.mode = 'scale'; 
                    this.initV = { s: this.sel.s, dist: Math.hypot(p.x - this.sel.x, p.y - this.sel.y) }; 
                    return;
                }
            }

            const list = [...this.items].sort((a,b) => b.z - a.z);
            let hit = null;
            for(let o of list) {
                if(!o._box) continue;
                const lp = this.toLocal(p, o);
                if(Math.abs(lp.x) < o._box.w/2 && Math.abs(lp.y) < o._box.h/2) {
                    hit = o; break;
                }
            }

            if(hit) {
                if(this.sel !== hit) {
                    this.sel = hit;
                    this.highlightPanel(hit.type); this.syncUI(hit);
                }
                this.pushHistory();
                this.mode = 'drag'; this.startP = p;
            } else {
                this.sel = null; this.mode = 'pan'; this.lastP = {x:e.clientX, y:e.clientY};
                this.highlightPanel('global');
            }
            this.render();
        });

        window.addEventListener('mousemove', e => {
            if(!this.mode) return;
            
            if(this.mode === 'pan') {
                this.view.x += e.clientX - this.lastP.x;
                this.view.y += e.clientY - this.lastP.y;
                this.lastP = {x:e.clientX, y:e.clientY};
                this.render(); return;
            }

            const p = this.getPointerPos(e);

            if(this.mode === 'drag' && this.sel) {
                this.sel.x += p.x - this.startP.x;
                this.sel.y += p.y - this.startP.y;
                this.startP = p;
            } else if(this.mode === 'rot' && this.sel) {
                const ang = Math.atan2(p.y - this.sel.y, p.x - this.sel.x);
                this.sel.r = this.initV.r + (ang - this.initV.ang);
            } else if(this.mode === 'scale' && this.sel) {
                const dist = Math.hypot(p.x - this.sel.x, p.y - this.sel.y);
                this.sel.s = Math.max(0.01, this.initV.s * (dist / this.initV.dist));
            }
            this.render();
        });

        window.addEventListener('mouseup', () => this.mode = null);
        v.addEventListener('wheel', e => {
            e.preventDefault();
            this.view.zoom *= e.deltaY > 0 ? 0.9 : 1.1;
            this.render();
        }, { passive: false });
    },

    // æ–°å¢ï¼šæ·»åŠ æ–‡å­—åŠŸèƒ½
    addText() {
        this.pushHistory();
        this.items.push({
            type: 'txt',
            val: 'è¾“å…¥æ–‡å­—',
            x: this.board.w / 2,
            y: this.board.h / 2,
            font: "'Ma Shan Zheng'",
            s: 80, w: 400, sp: 0, c: '#000000', sc: '#000000', sb: 0, r: 0, z: 300
        });
        this.sel = this.items[this.items.length-1];
        this.syncUI(this.sel);
        this.highlightPanel('txt');
        this.render();
    },

    updateSel(k, v) {
        if(!this.sel) return;
        if(k === 'font') {
            document.fonts.load(`30px ${v}`).then(() => {
                this.sel[k] = v; this.render();
            });
        }
        this.sel[k] = v;
        this.render();
    },

    loadImg(el, type) {
        if(!el.files[0]) return;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                this.pushHistory();
                if(type === 'logo') {
                    const l = this.items.find(x=>x.id==='logo');
                    l.img = img; l.w=img.width; l.h=img.height; l.s = 200/img.width;
                }
                this.render();
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(el.files[0]);
    },

    handleDrop(e) {
        const f = e.dataTransfer.files[0];
        if(f && f.type.startsWith('image')) {
            const r = new FileReader();
            r.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    this.extractColors(img);
                    this.pushHistory();
                    const s = Math.max(this.board.w/img.width, this.board.h/img.height);
                    this.items.push({ type: 'img', img: img, w: img.width, h: img.height, x: this.board.w/2, y: this.board.h/2, s: s, r: 0, z: 50 });
                    this.render();
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(f);
        }
    },

    extractColors(img) {
        const c = document.createElement('canvas'); c.width=50; c.height=50;
        const x = c.getContext('2d'); x.drawImage(img,0,0,50,50);
        const data = x.getImageData(0,0,50,50).data;
        let colors = [];
        for(let i=0; i<data.length; i+=400) colors.push(`rgb(${data[i]},${data[i+1]},${data[i+2]})`);
        const unique = [...new Set(colors)].slice(0, 5);
        const pal = document.getElementById('smart-colors');
        pal.innerHTML = '';
        unique.forEach(c => {
            const div = document.createElement('div');
            div.className = 'dot'; div.style.background = c;
            div.onclick = () => { this.pushHistory(); this.applyColor(this.rgbToHex(c)); };
            pal.appendChild(div);
        });
    },

    applyColor(hex) {
        document.getElementById('barC').value = hex;
        const contrast = invertColor(hex);
        this.items.forEach(i => { if(i.type === 'txt' || i.type === 'num') i.c = contrast; });
        if(this.sel && (this.sel.type === 'txt' || this.sel.type === 'num')) this.syncUI(this.sel);
        this.render();
    },

    highlightPanel(type) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        if(type === 'txt') document.getElementById('p-txt').classList.add('active');
        else if(type === 'num') document.getElementById('p-num').classList.add('active');
        else document.getElementById('p-global').classList.add('active');
    },

    syncUI(o) {
        if(!o) return;
        if(o.type === 'txt') {
            document.getElementById('t-val').value = o.val;
            document.getElementById('t-font').value = o.font;
            document.getElementById('t-c').value = o.c;
            document.getElementById('t-s').value = o.s;
            document.getElementById('t-w').value = o.w;
            document.getElementById('t-sp').value = o.sp;
            document.getElementById('t-sc').value = o.sc;
            document.getElementById('t-sb').value = o.sb;
        }
        if(o.type === 'num') {
            document.getElementById('n-st').value = o.st;
            document.getElementById('n-c').value = o.c;
            document.getElementById('n-s').value = o.s;
            document.getElementById('n-w').value = o.w;
            document.getElementById('n-sc').value = o.sc;
            document.getElementById('n-sb').value = o.sb;
        }
    },

    openSave() { document.getElementById('save-modal').style.display='flex'; },
    closeModal(t) { document.getElementById(t+'-modal').style.display='none'; },
    confirmSave() {
        const n = document.getElementById('preset-name-input').value; if(!n) return alert("è¯·è¾“å…¥åç§°");
        const data = this.items.filter(x=>x.type!=='img'||x.isLogo).map(x=>{const c={...x}; delete c.img; delete c._box; return c;});
        const st = {
            w:this.board.w, h:this.board.h, 
            bar: { h:document.getElementById('barH').value, f:document.getElementById('barF').value, c:document.getElementById('barC').value },
            items:data
        };
        localStorage.setItem('PRE_'+n, JSON.stringify(st));
        this.closeModal('save');
        alert("é¢„è®¾ä¿å­˜æˆåŠŸï¼(èƒŒæ™¯å›¾ä¸ä¼šè¢«ä¿å­˜)");
    },
    openLoad() {
        const l = document.getElementById('preset-list'); l.innerHTML = '';
        Object.keys(localStorage).filter(k=>k.startsWith('PRE_')).forEach(k=>{
            const n = k.replace('PRE_','');
            l.innerHTML += `<div class="preset-item"><span class="preset-name">${n}</span><div class="preset-actions"><button onclick="app.loadP('${n}')">è¯»å–</button><button class="danger" onclick="app.delP('${n}')">Ã—</button></div></div>`;
        });
        document.getElementById('load-modal').style.display='flex';
    },
    loadP(n) {
        const d = JSON.parse(localStorage.getItem('PRE_'+n));
        this.board=d.board; ['cw','ch'].forEach(k=>document.getElementById(k).value=this.board[k==='cw'?'w':'h']);
        ['barH','barF','barC'].forEach(k => document.getElementById(k).value = d.bar[k.replace('bar','').toLowerCase()] || (k==='barC'?'#fff':0));
        
        const cache={}; this.items.forEach(i=>{if(i.img) cache[i.id||i.z]=i.img});
        this.items = d.items.map(o => {
            if(o.type==='img'||o.id==='logo') {
                if(cache[o.id||o.z]) o.img = cache[o.id||o.z];
                else if(o.isLogo) { const i=new Image(); i.crossOrigin="Anonymous"; i.src=DEF_LOGO; i.onload=()=>this.render(); o.img=i; }
            }
            return o;
        });
        this.sel=null; this.closeModal('load'); this.centerView();
    },
    delP(n) { if(confirm('åˆ ?')) { localStorage.removeItem('PRE_'+n); this.openLoad(); } },

    async download() {
        const name = prompt("æ–‡ä»¶å", "Cover") || "Cover";
        const type = document.getElementById('dl-type').value;
        const start = parseInt(document.getElementById('dl-start').value);
        const count = parseInt(document.getElementById('dl-count').value);
        
        document.getElementById('loader').style.display='flex';
        this.sel=null; this.render();
        const ec=document.createElement('canvas'), ex=ec.getContext('2d'), oc=this.ctx, ov=this.cvs;
        this.ctx=ex; this.cvs=ec;

        try {
            if(type==='zip') {
                const zip=new JSZip();
                for(let i=0;i<count;i++) { this.render(true, start+i); const b=await new Promise(r=>ec.toBlob(r,'image/jpeg',0.95)); zip.file(`${name}_${start+i}.jpg`, b); }
                saveAs(await zip.generateAsync({type:"blob"}), `${name}.zip`);
            } else {
                for(let i=0;i<count;i++) { this.render(true, start+i); await new Promise(r=>ec.toBlob(b=>{saveAs(b, `${name}_${start+i}.jpg`);r()},'image/jpeg',0.95)); }
            }
        } catch(e){alert("Error")}
        
        this.ctx=oc; this.cvs=ov; document.getElementById('loader').style.display='none'; this.render();
    }
};

app.init();
</script>
</body>
</html>
